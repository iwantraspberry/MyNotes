# コードレビュー方針

このドキュメントは、複数クラスにまたがる変更を含むプルリクエスト（PR）を含めたコードレビューの標準的な進め方・チェックリスト・テンプレートをまとめたものです。実務でレビューの見落としや混乱を減らすことを目的としています。

---

## 目的
- 変更の意図を速やかに把握できるようにする
- 品質（機能正しさ・セキュリティ・パフォーマンス・保守性）を確保する
- レビューの効率化と一貫性の確保
- レビューを通じたナレッジ共有とチームの改善

---

## PR 作成者への必須項目（PR を作るときに必ず記載する）
1. What（何を変えたか）
2. Why（なぜその変更が必要か）
3. How（どのように実装したか、主要な設計決定）
4. 影響範囲（破壊的変更、DBスキーマ、外部API、互換性）
5. テスト手順（ローカルでの再現手順、重要なテスト）
6. Rollback / リスク（失敗時の対応、ロールバック手順）
7. 重要ファイル一覧（エントリポイントや主要クラスのパス）

短いシーケンス図やフロー図があるとレビューが非常に速くなります。

---

## レビューの基本フロー（レビュアー向け）
1. PRの説明を読む（上記必須項目が揃っているか確認）
2. CIの結果とテスト成功を確認
3. 変更のスコープを把握（影響を受けるパッケージ群）
4. 「読む順序」に従って主要箇所を読む（下記参照）
5. テストを実行（可能ならローカルで動かす）
6. 詳細確認（ロジック、例外処理、トランザクション、スレッド安全）
7. 非機能面の確認（パフォーマンス、セキュリティ、ログ/トレース、監視）
8. コメントを出す（優先度を明確に：MUST/SHOULD/NICE）
9. 必要なら著者と短いペアレビュー（画面共有）を実施

---

## 読む順序（複数クラスにまたがるPRでの鉄則）
1. PR説明（What/Why/How）
2. エントリポイント（Controller / REST handler / Message handler）
3. ユースケース層（Service / UseCase）
4. ドメインモデル（Entities / DTO）
5. リポジトリ / DAO（クエリ、トランザクション影響）
6. 外部連携（HTTP クライアント、ファイル操作、キュー）
7. 設定 / DI / Bean 定義（@Configuration）
8. トランザクション境界（@Transactional の位置）
9. テスト（unit → integration → e2e）
10. ロギング・メトリクス周り

この順序で読むと「なぜその実装になったか」が理解しやすくなります。

---

## レビューで必ず確認するチェックリスト

必須（FAIL FAST）
- [ ] PR説明に What/Why/How があるか
- [ ] CI／テストが通っているか
- [ ] API/DBの破壊的変更の明示があるか
- [ ] セキュリティ（認証・認可・入力検証）が適切か
- [ ] トランザクションが適切に境界設定されているか（長時間トランザクションが無いか）
- [ ] グローバルな可変状態（mutable singleton, ThreadLocal）が誤用されていないか
- [ ] リソースリーク（connection/stream）の可能性がないか
- [ ] 機密情報がコードやログにハードコーディングされていないか

推奨
- [ ] 単一責任（SRP）に沿っているか（メソッドが長すぎないか）
- [ ] 名前付け・APIが一貫しているか
- [ ] N+1 等の DB 問題が無いか
- [ ] テストで境界条件とエラーケースがカバーされているか
- [ ] ログに相関ID (MDC) などコンテキストが含まれているか（運用観点）
- [ ] メトリクス（処理時間、エラー率）を出すべき箇所は対応されているか

低優先
- [ ] 細かなリファクタ（読みやすさの改善）
- [ ] ログ文言や細かいスタイル調整

---

## PR の分割ルール（大きな変更を扱うとき）
- 基本は小さく分ける：API / DB マイグレーション / 実装 / テスト を分ける
- どうしても分割できない場合：
  - PR の冒頭に高レベル図を付ける
  - コミットを論理単位で分けてあるか確認する
  - レビュアーとペアレビューする（必須）

---

## コメントテンプレート（レビュアーが使える短文例）

MUST（修正必須）
- "MUST: このメソッドはトランザクション内で長時間ブロッキングされる可能性があります。トランザクション外に移すかタイムアウト/リトライを追加してください。"

SHOULD（強く推奨）
- "SHOULD: `OrderService` の責務がやや大きいです。支払い処理を別クラスに切り出すことを提案します（理由: テスト容易性、変更影響の局所化）。"

NICE（任意）
- "NICE: ロジックは読みやすいですが、`tmp` のような汎用名が使われています。`userCountCache` のような説明的な名前にしてください。"

称賛
- "Good: 重要なエラーケースまできっちりテストされている点が素晴らしいです。"

コメントは「事実 → 影響 → 提案」の順で書くと受け入れられやすいです。

---

## 対応が必要な特殊ケース

- DB スキーマ変更
  - マイグレーションは別PRにする。ロールアウト手順・backfill を必ず記載。
- 外部APIの変更
  - バージョン互換性、フォールバックの扱いを明示する。
- 非同期処理
  - コンテキスト伝播（SecurityContext/RequestContext）や例外ハンドリングの方法を明示する。
- 大量データ処理
  - チャンクサイズやプール数などパフォーマンスチューニングの指標を添える。

---

## ツールと自動化（推奨）
- CI: ビルド／ユニットテスト／静的解析（Checkstyle/PMD/SpotBugs）を必須にする
- 依存性チェック: OWASP Dependency-Check
- カバレッジ: Jacoco（差分に対するカバレッジを報告）
- ローカル検証: IDE の Call Hierarchy / Find Usages を活用
- デバッグ: 必要なら短いペアレビュー（画面共有）で著者に実行フローを説明してもらう

---

## レビュー文化（チームルール）
- 指摘は具体的に、代替案を示す（コード例が望ましい）
- トーンは建設的に（まず良い点を述べる）
- 争点は短いミーティングで解決する（コメントで長々議論しない）
- レビューは 30–60 分が目安。長時間のレビューは分割を要求する

---

## 付録：PRテンプレ（コピーして使える）
```
What:
Why:
How:
影響範囲:
テスト手順:
Rollback/リスク:
主要ファイル:
図（任意）:
```

---

## 最後に
このガイドは最初のバージョンです。実運用での痛みどころを把握した上で改善していくことを推奨します。チームに合わせて「必須チェック項目」や「テンプレ」をカスタマイズしてください。
